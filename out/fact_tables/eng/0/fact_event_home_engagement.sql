BEGIN;
DELETE FROM dwh.fact_event_home_engagement WHERE DATE_TRUNC(''day'', event_date_time_pt) >= DATEADD('DAY',-7,'{start_date}');

INSERT INTO dwh.fact_event_home_engagement 
(  SELECT   name as event_name   ,data:properties:CAST(engagement_type AS STRING) engagement_type   ,data:CAST(receivedAt AS DATE)time event_date_time_utc   ,data:CAST(receivedAt AS DATE) event_date_utc   ,CONVERT_TIMEZONE('America/Los_Angeles',data:CAST(receivedAt AS DATE)time)::datetime  event_date_time_pt   ,CONVERT_TIMEZONE('America/Los_Angeles',data:CAST(receivedAt AS DATE)time)::date event_date_pt   ,data:properties:CAST(platform AS STRING) platform   ,data:context:app:CAST(version AS STRING) as app_version   ,try_cast(data:properties:CAST(user_id AS STRING) as integer) as user_id   ,data:properties:CAST(ahoy_visit_token AS STRING) as visit_token   ,data:properties:CAST(ahoy_visitor_token AS STRING) as visitor_token   ,try_cast(data:properties:CAST(warehouse_id AS STRING) as integer) warehouse_id   ,try_cast(data:properties:CAST(whitelabel_id AS STRING) as integer) whitelabel_id   ,try_cast(data:properties:CAST(country_id AS STRING) as integer) as country_id   ,try_cast(data:properties:CAST(inventory_area_id AS STRING) as integer) inventory_area_id   ,try_cast(data:properties:CAST(region_id AS STRING) as integer) region_id   ,try_cast(data:properties:CAST(zone_id AS STRING) as integer) zone_id   ,data:properties:CAST(zip_code AS STRING) zip_code   ,try_cast(data:properties:CAST(zip_active AS STRING) as BOOLEAN) zip_active   ,data:properties:CAST(service_type AS STRING) as service_type   ,data:properties:CAST(home_load_id AS STRING) home_load_id   ,data:properties:CAST(section_type AS STRING) section_type   ,data:properties:CAST(element_load_id AS STRING) element_load_id   ,data:properties:engagement_details engagement_details   ,data:properties:section_details as section_details   ,data:properties:CAST(element_type AS STRING) as element_type   ,data:properties:CAST(ranking_request_id AS STRING) as retailer_ranking_request_id   ,data:properties:element_details as element_details   FROM		instadata.events_customers_v2.home h  WHERE	h.name in ('home.display','home.engagement')	AND DATE_TRUNC(''day'', CONVERT_TIMEZONE('America/Los_Angeles',CAST(received_at AS DATE)time)::datetime) >= DATEADD('DAY',-7,'{start_date}')	AND data:properties:CAST(platform AS STRING) in ('ios','android','web','mobile_web')    );